<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>üîç Teste de Conex√£o Supabase</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1a1a2e;
            color: #eee;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .test {
            background: #16213e;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #666;
        }
        .test.success {
            border-left-color: #4caf50;
        }
        .test.error {
            border-left-color: #f44336;
        }
        .test.warning {
            border-left-color: #ff9800;
        }
        pre {
            background: #0f3460;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        button {
            background: #E91E63;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 0;
        }
        button:hover {
            background: #C2185B;
        }
    </style>
</head>
<body>
    <h1>üîç Diagn√≥stico de Conex√£o com Supabase</h1>
    <p>Este teste vai verificar se o sistema consegue realmente conectar e salvar no banco de dados.</p>
    
    <button onclick="runTests()">‚ñ∂Ô∏è Executar Testes</button>
    
    <div id="results"></div>

    <script src="./public/js/supabase-client.js"></script>
    <script>
        const resultsDiv = document.getElementById('results');

        function addTest(title, status, message, data) {
            const div = document.createElement('div');
            div.className = `test ${status}`;
            div.innerHTML = `
                <h3>${status === 'success' ? '‚úÖ' : status === 'error' ? '‚ùå' : '‚ö†Ô∏è'} ${title}</h3>
                <p>${message}</p>
                ${data ? `<pre>${JSON.stringify(data, null, 2)}</pre>` : ''}
            `;
            resultsDiv.appendChild(div);
        }

        async function runTests() {
            resultsDiv.innerHTML = '<h2>üîÑ Executando testes...</h2>';

            // TESTE 1: Verificar se o cliente Supabase existe
            if (!window.supabase) {
                addTest('Cliente Supabase', 'error', 'Objeto window.supabase n√£o encontrado!');
                return;
            }
            addTest('Cliente Supabase', 'success', 'Cliente Supabase carregado com sucesso');

            // TESTE 2: Verificar URL e KEY
            const url = window.supabase.url;
            const key = window.supabase.key;
            
            if (!url || !url.includes('supabase.co')) {
                addTest('URL do Supabase', 'error', `URL inv√°lida: ${url}`);
            } else {
                addTest('URL do Supabase', 'success', `URL configurada: ${url}`);
            }

            if (!key || key.length < 100) {
                addTest('Chave Anon', 'error', `Chave muito curta ou inv√°lida! Tamanho: ${key ? key.length : 0} caracteres (deveria ter ~200+)`, { key_preview: key ? key.substring(0, 50) + '...' : 'NULA' });
            } else {
                addTest('Chave Anon', 'success', `Chave configurada (${key.length} caracteres)`);
            }

            // TESTE 3: Testar SELECT (leitura)
            try {
                addTest('Teste de Leitura', 'warning', 'Tentando buscar usu√°rios...');
                const result = await supabase.select('usuarios', { limit: 1 });
                
                if (result.success) {
                    addTest('Teste de Leitura', 'success', `SELECT funcionou! Encontrados ${result.data?.length || 0} registros`, result.data);
                } else {
                    addTest('Teste de Leitura', 'error', `SELECT falhou: ${result.error}`, result);
                }
            } catch (error) {
                addTest('Teste de Leitura', 'error', `Exce√ß√£o ao fazer SELECT: ${error.message}`, { error: error.stack });
            }

            // TESTE 4: Verificar RLS (Row Level Security)
            try {
                addTest('Teste de RLS', 'warning', 'Verificando pol√≠ticas de seguran√ßa...');
                
                const testProduct = {
                    id: 'test_' + Date.now(),
                    usuario_id: 'test_user',
                    nome: 'Produto de Teste',
                    custo_base: 10.00,
                    preco_venda: 20.00,
                    margem_lucro: 100,
                    tipo_variacao: 'none',
                    variacoes: [],
                    estoque: {},
                    imagens: [],
                    imagem_url: '',
                    ativo: true,
                    visivel_catalogo: false // N√£o mostrar no cat√°logo
                };

                const insertResult = await supabase.insert('produtos', testProduct);
                
                if (insertResult.success) {
                    addTest('Teste de INSERT', 'success', '‚úÖ INSERT FUNCIONOU! O banco est√° aceitando escritas!', insertResult.data);
                    
                    // Limpar teste
                    await supabase.delete('produtos', testProduct.id);
                } else {
                    addTest('Teste de INSERT', 'error', `‚ùå INSERT FALHOU! Poss√≠vel problema de RLS ou permiss√µes: ${insertResult.error}`, insertResult);
                }
            } catch (error) {
                addTest('Teste de INSERT', 'error', `Exce√ß√£o ao fazer INSERT: ${error.message}`, { error: error.stack });
            }

            // TESTE 5: Verificar se h√° dados antigos
            try {
                const userId = localStorage.getItem('lucrocerto_user_id');
                if (userId) {
                    addTest('User ID', 'success', `User ID encontrado no localStorage: ${userId}`);
                    
                    const produtos = await supabase.select('produtos', { filters: { usuario_id: userId } });
                    addTest('Produtos do Usu√°rio', produtos.data?.length > 0 ? 'success' : 'warning', 
                        `Encontrados ${produtos.data?.length || 0} produtos no banco`, produtos.data);
                } else {
                    addTest('User ID', 'warning', 'Nenhum user_id encontrado. Fa√ßa login primeiro.');
                }
            } catch (error) {
                addTest('Produtos do Usu√°rio', 'error', `Erro ao buscar: ${error.message}`);
            }

            addTest('Diagn√≥stico Completo', 'success', 'Todos os testes foram executados. Verifique os resultados acima.');
        }
    </script>
</body>
</html>
